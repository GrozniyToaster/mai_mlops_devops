# Лабораторная работа 2: MLflow для отслеживания экспериментов машинного обучения

## Задание
Развернуть сервер MLFlow и адаптировать решение для машинного обучения. Использовать MLFlow в CI/CD и описать, почему использование MLFlow помогает в данной реализации.

## Структура проекта

### Файлы проекта
- **docker-compose.yml** - конфигурация Docker Compose для развертывания инфраструктуры MLflow
- **Dockerfile.mlflow** - Dockerfile для сборки образа сервера MLflow
- **Dockerfile.model** - Dockerfile для сборки образа с моделью машинного обучения
- **train_model.py** - скрипт для обучения модели с использованием MLflow для отслеживания
- **requirements.txt** - зависимости Python для проекта

### Компоненты инфраструктуры
1. **MLflow Server** - сервер MLflow для отслеживания экспериментов с локальным хранилищем (SQLite + файловая система)
2. **Model Training** - сервис для обучения модели машинного обучения

## Как использовать

### Запуск инфраструктуры
```bash
cd lab2
docker compose up -d
```

### Доступ к MLflow UI
После запуска инфраструктуры, MLflow UI будет доступен по адресу: http://localhost:5000

### Запуск обучения модели
```bash
docker compose up model-training
```

## CI/CD с использованием GitHub Actions и uv

В проекте настроен CI/CD с использованием GitHub Actions и инструмента uv для управления зависимостями Python. **Важно отметить, что CI/CD настроен в корне репозитория**, а не в директории lab2. Workflow находится в файле `.github/workflows/mlflow-ci.yml` и включает:

1. **Тестирование**:
   - Установка зависимостей с помощью uv
   - Линтинг кода с помощью flake8
   - Проверка конфигурации Docker Compose

2. **Сборка и тестирование**:
   - Сборка Docker-образов с использованием uv для ускорения установки зависимостей
   - Запуск и тестирование инфраструктуры

### Как работает CI/CD пайплайн

1. **Триггеры запуска**:
   - Пайплайн запускается при push в ветку main
   - Пайплайн запускается при создании pull request в ветку main
   - Пайплайн запускается только если изменения затрагивают файлы в директории lab2 или сам workflow-файл

2. **Этап тестирования**:
   - Checkout кода из репозитория
   - Установка Python 3.9
   - Установка инструмента uv
   - Установка зависимостей из requirements.txt с помощью uv
   - Проверка кода с помощью flake8
   - Валидация конфигурации Docker Compose

3. **Этап сборки и тестирования** (только для push в main):
   - Настройка Docker Buildx
   - Сборка образа MLflow сервера
   - Сборка образа для обучения модели
   - Запуск Docker Compose для проверки работоспособности
   - Проверка логов и статуса контейнеров
   - Остановка контейнеров

Инструмент uv используется не только в CI/CD, но и в Docker-образах для ускорения процесса установки зависимостей, что значительно сокращает время сборки образов.

## Почему MLflow полезен в данной реализации

MLflow предоставляет несколько ключевых преимуществ для данного проекта:

1. **Отслеживание экспериментов**: MLflow позволяет отслеживать параметры, метрики и артефакты моделей машинного обучения, что упрощает сравнение различных экспериментов и выбор лучшей модели.

2. **Воспроизводимость**: MLflow сохраняет информацию о среде выполнения, коде и данных, что обеспечивает воспроизводимость экспериментов.

3. **Централизованное хранение**: Все эксперименты хранятся в централизованном месте (SQLite для метаданных и локальная файловая система для артефактов), что упрощает доступ к ним и их анализ.

4. **Интеграция с CI/CD**: MLflow легко интегрируется с CI/CD-пайплайнами, позволяя автоматизировать процесс обучения, оценки и развертывания моделей.

5. **Визуализация**: MLflow предоставляет удобный веб-интерфейс для визуализации результатов экспериментов, что упрощает анализ и сравнение моделей.

6. **Управление моделями**: MLflow Model Registry позволяет управлять жизненным циклом моделей, включая версионирование, переход между стадиями (разработка, тестирование, продакшн) и развертывание.

В контексте данного проекта, MLflow особенно полезен для:
- Отслеживания параметров и метрик модели RandomForestRegressor
- Сохранения обученной модели в стандартизированном формате
- Визуализации результатов обучения через веб-интерфейс
- Обеспечения воспроизводимости экспериментов в CI/CD-пайплайне

Использование MLflow в CI/CD позволяет автоматизировать процесс обучения и оценки моделей, а также обеспечивает прозрачность и воспроизводимость этого процесса, что критически важно для надежного машинного обучения.

## Сложности и неудобства в ходе работы

В процессе работы с MLflow в контексте Docker и CI/CD были выявлены следующие сложности и неудобства:

1. **Развертывание MLflow в Docker**:
   - MLflow не очень удобно разворачивать в Docker-контейнерах. Эта система предполагает быть развернутой в Kubernetes с настоящими базами данных (PostgreSQL, MySQL) и объектными хранилищами (S3, MinIO).
   - Локальное хранилище (SQLite + файловая система) имеет ограничения по производительности и масштабируемости.
   - Возникают проблемы с правами доступа к файлам и директориям при использовании Docker-томов.

2. **Интеграция с CI/CD**:
   - В CI/CD пайплайне нужно обращаться не к созданному в рамках тестов MLflow серверу, а к единому MLflow серверу, в котором сохраняются исторические метрики модели.
   - Текущая реализация создает изолированный MLflow сервер для каждого запуска CI/CD, что не позволяет отслеживать прогресс моделей между разными запусками.
   - Отсутствие централизованного хранилища метрик затрудняет анализ тенденций и выявление регрессий в производительности моделей.

3. **Управление зависимостями**:
   - Несмотря на использование uv для ускорения установки зависимостей, сборка Docker-образов все равно занимает значительное время.
   - Возникают конфликты версий между зависимостями MLflow и библиотеками машинного обучения.

## Рекомендации для улучшения

1. **Для продакшн-окружения**:
   - Развернуть MLflow в Kubernetes с использованием Helm-чартов
   - Использовать PostgreSQL для хранения метаданных вместо SQLite
   - Настроить объектное хранилище (S3, MinIO) для артефактов моделей
   - Настроить аутентификацию и авторизацию для MLflow

2. **Для CI/CD**:
   - Настроить постоянный MLflow сервер, к которому будут обращаться все CI/CD пайплайны
   - Реализовать механизм сравнения метрик текущей модели с предыдущими версиями
   - Добавить автоматические тесты для проверки качества моделей
